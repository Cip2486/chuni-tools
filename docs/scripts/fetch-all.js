(()=>{"use strict";var e,t;function r(e){const t=document.cookie.split(";").map((e=>decodeURIComponent(e.trim()))).map((e=>e.split("="))).find((t=>t[0]===e));return t?t[1]:""}function a(e){return Number([...e].filter((e=>","!==e)).join(""))}!function(e){e.en_US="en_US",e.zh_TW="zh_TW"}(e||(e={})),function(e){e.basic="BAS",e.advanced="ADV",e.expert="EXP",e.master="MAS",e.ultima="ULT"}(t||(t={}));const n=Object.values(t);var o;!function(e){e["P & A"]="0",e.niconico="2",e["東方Project"]="3",e.ORIGINAL="5",e.VARIETY="6",e["イロドリ"]="7",e["ゲキマイ"]="9"}(o||(o={})),Object.keys(o);const c="https://chunithm-net-eng.com";async function i(e,t){const r=await fetch(c+e,{headers:{"Cache-Control":"no-cache"},method:t?"POST":"GET",body:t});if(503===r.status||405===r.status)throw new Error("Service temporarily unavailable");if(-1!=r.url.indexOf("/error"))throw new Error("Request failed: rejected by server");return(new DOMParser).parseFromString(await r.text(),"text/html")}!async function(o){const l={[e.en_US]:{pleaseLogin:"Please login to CHUNITHM-NET first.",needReload:"Oops! Something went wrong, please reload CHUNITHM-NET.",analyzeRating:"Analyze Rating"},[e.zh_TW]:{pleaseLogin:"請先登入 CHUNITHM-NET 再執行本程式。",needReload:"唉呀，看來我們這裡出了一點小意外，請重新整理 CHUNITHM-NET。",analyzeRating:"分析遊戲成績"}}[function(){const t=new URLSearchParams(location.search);return t.get("lang")?t.get("lang").startsWith("zh")?e.zh_TW:e.en_US:function(){switch(localStorage.language){case e.en_US:return e.en_US;case e.zh_TW:return e.zh_TW}return null}()||(navigator.language.startsWith("zh")?e.zh_TW:e.en_US)}()];if(!r("_t"))return alert(l.pleaseLogin),void(window.location.href=c);try{!function(){const e=o.createElement("a");e.className="chuni-tool-btn",o.styleSheets[0].insertRule(".chuni-tool-btn {\n    color: white;\n    font-size: 1.5em;\n    font-weight: bold;\n    padding: 1.5rem;\n    margin: 2rem auto;\n    display: block;\n    width: -moz-fit-content;\n    width: fit-content;\n    text-decoration: none;\n    border-radius: .5rem;\n    border: 3px solid #567;\n    background-color: #234;\n    text-align: center;\n    cursor: pointer;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    filter: brightness(.7);\n    transition: 0.2s;\n}"),o.styleSheets[0].insertRule("\n.chuni-tool-btn:hover {\n    filter: brightness(1);\n    color: white;\n}"),e.innerText=l.analyzeRating,e.href=function(e){const t=Array.from(document.querySelectorAll("script"));for(;t.length;){const e=t.pop();if(e?.src.includes("fetch-all")){const t=new URL(e.src),r=t.pathname;return t.origin+r.substring(0,r.lastIndexOf("/scripts"))}}return"https://dogeon188.github.io/chuni-tools/"}()+"/record-viewer/#best",e.target="recordViewer",o.getElementById("inner")?.insertAdjacentElement("beforebegin",e)}(),window.addEventListener("message",(function(e){switch(e.data.action){case"request":!function(e){console.log("%cReceived request for: %c"+e.data.payload.target,"color: gray","color: white");const o=function(e,t){if(!e)throw new Error("Target window does not exist");return(r,a)=>{const n={action:r,payload:a};e.postMessage(n,t)}}(e.source,e.origin);let c;switch(e.data.payload.target){case"bestRecord":console.log("%c    Target difficulty: %c"+e.data.payload.data.difficulty,"color: gray","color: white"),c=async function(e=t.master){const n=new FormData;n.append("genre","99"),n.append("token",r("_t"));const o={[t.ultima]:"sendUltima",[t.master]:"sendMaster",[t.expert]:"sendExpert",[t.advanced]:"sendAdvanced",[t.basic]:"sendBasic"}[e],c=await i("/mobile/record/musicGenre/"+o,n);return Array.from(c.querySelectorAll(".box01.w420")[1].querySelectorAll("form")).map((t=>{const r=t.querySelector(".play_musicdata_icon"),n=t.querySelector(".text_b")?.innerHTML;return{title:t.querySelector(".music_title")?.innerHTML,score:n?a(n):void 0,difficulty:e,clear:r?.querySelector('img[src*="alljustice"]')?"AJ":r?.querySelector('img[src*="fullcombo"]')?"FC":"",idx:t.querySelector('input[name="idx"]').value}})).filter((e=>null!==e.title&&e.score&&e.score>0))}(e.data.payload.data.difficulty);break;case"playHistory":c=async function(){const e=await i("/mobile/record/playlog");return Array.from(e.querySelectorAll(".mt_10 .frame02.w400")).map((e=>{const r=e.querySelector(".play_musicdata_score_text")?.innerHTML,n=e.querySelector(".play_track_result img").src,o=/musiclevel_.*(?=\.png)/.exec(n)[0].slice(11),c=Array.from(e.querySelectorAll(".play_musicdata_icon"));return{title:e.querySelector(".play_musicdata_title")?.innerHTML,score:a(r),difficulty:"ultimate"==o?"ULT":t[o],clear:c.some((e=>e.querySelector('img[src*="alljustice"]')))?"AJ":c.some((e=>e.querySelector('img[src*="fullcombo"]')))?"FC":"",timestamp:Date.parse(e.querySelector(".play_datalist_date")?.innerHTML)}}))}();break;case"recentRecord":c=async function(){const e=await i("/mobile/home/playerData/ratingDetailRecent");return Array.from(e.querySelectorAll("form")).map((e=>{const r=e.querySelector("input[name=diff]")?.value;return{title:e.querySelector(".music_title")?.innerHTML,score:a(e.querySelector(".text_b")?.innerHTML),difficulty:Object.values(t)[parseInt(r)],clear:""}}))}();break;case"playerStats":c=async function(){const e=await i("/mobile/home/playerData"),t=e.querySelector(".player_honor_short"),r=/honor_bg_.*(?=\.png)/.exec(t.style.backgroundImage),a=Array.from(e.querySelectorAll(".player_rating_num_block img")).map((e=>/rating_.*_comma.png/.test(e.src)?".":/rating_.*_[0-9]*(?=\.png)/.exec(e.src)[0].slice(-1))).join("");return{name:e.querySelector(".player_name_in")?.innerHTML,honor:{text:e.querySelector(".player_honor_text_view span")?.innerHTML,color:r?r[0].slice(9):"normal"},rating:a,ratingMax:e.querySelector(".player_rating_max")?.innerHTML,playCount:e.querySelector(".user_data_play_count .user_data_text")?.innerHTML}}();break;case"songPlayCount":console.log("%c    Target song id: %c"+e.data.payload.data.idx,"color: gray","color: white"),console.log("%c    Target difficulty: %c"+e.data.payload.data.difficulty,"color: gray","color: white"),c=async function(e,a){const o=new FormData;o.append("idx",e),o.append("genre","99"),o.append("diff",n.indexOf(a).toString()),o.append("token",r("_t"));const c=(await i("/mobile/record/musicGenre/sendMusicDetail/",o)).querySelectorAll(`.music_box.bg_${Object.entries(t).find((e=>e[1]===a))[0]} .box14 > div`)[1].querySelector(".text_b")?.innerHTML.replace("times","");return parseInt(c)}(e.data.payload.data.idx,e.data.payload.data.difficulty)}o("preflight",{target:e.data.payload.target,uuid:e.data.payload.uuid}),c?.then((t=>{o("respond",{target:e.data.payload.target,uuid:e.data.payload.uuid,data:t})})).catch((t=>{console.error(t),o("respond",{target:e.data.payload.target,uuid:e.data.payload.uuid,error:t})}))}(e);break;case"saveConfig":const o=e.data.payload.data?.lang;o&&(function(e){localStorage.language=e}(o),console.log("%cChange language preferences to: %c"+o,"color: gray","color: white"))}}),!1)}catch(e){alert(l.needReload),console.log(e)}}(document)})();