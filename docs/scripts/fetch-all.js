(()=>{"use strict";var e;function t(e){const t=document.cookie.split(";").map((e=>decodeURIComponent(e.trim()))).map((e=>e.split("="))).find((t=>t[0]===e));return t?t[1]:""}!function(e){e.en_US="en_US",e.zh_TW="zh_TW"}(e||(e={}));const r="https://chunithm-net-eng.com";function n(e){return Number([...e].filter((e=>","!==e)).join(""))}var o;!function(e){e.basic="BAS",e.advanced="ADV",e.expert="EXP",e.master="MAS",e.ultima="ULT"}(o||(o={}));const a=Object.values(o);var c;async function i(e,t){const n=await fetch(r+e,{headers:{"Cache-Control":"no-cache"},method:t?"POST":"GET",body:t});if(503===n.status||405===n.status)throw new Error("Service temporarily unavailable");if(-1!=n.url.indexOf("/error"))throw new Error("Request failed: rejected by server");return(new DOMParser).parseFromString(await n.text(),"text/html")}!function(e){e["P & A"]="0",e.niconico="2",e["東方Project"]="3",e.ORIGINAL="5",e.VARIETY="6",e["イロドリ"]="7",e["ゲキマイ"]="9"}(c||(c={})),Object.keys(c),async function(c){const l={[e.en_US]:{pleaseLogin:"Please login to CHUNITHM-NET first.",needReload:"Oops! Something went wrong, please reload CHUNITHM-NET.",analyzeRating:"Analyze Rating"},[e.zh_TW]:{pleaseLogin:"請先登入 CHUNITHM-NET 再執行本程式。",needReload:"唉呀，看來我們這裡出了一點小意外，請重新整理 CHUNITHM-NET。",analyzeRating:"分析遊戲成績"}}[function(){const t=new URLSearchParams(location.search);return t.get("lang")?t.get("lang").startsWith("zh")?e.zh_TW:e.en_US:function(){switch(localStorage.language){case e.en_US:return e.en_US;case e.zh_TW:return e.zh_TW}return null}()||(navigator.language.startsWith("zh")?e.zh_TW:e.en_US)}()];if(!t("_t"))return alert(l.pleaseLogin),void(window.location.href=r);try{!function(){const e=c.createElement("a");e.className="chuni-tool-btn",c.styleSheets[0].insertRule(".chuni-tool-btn {\n    color: white;\n    font-size: 1.5em;\n    font-weight: bold;\n    padding: 1.5rem;\n    margin: 2rem auto;\n    display: block;\n    width: -moz-fit-content;\n    width: fit-content;\n    text-decoration: none;\n    border-radius: .5rem;\n    border: 3px solid #567;\n    background-color: #234;\n    text-align: center;\n    cursor: pointer;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n    filter: brightness(.7);\n    transition: 0.2s;\n}"),c.styleSheets[0].insertRule("\n.chuni-tool-btn:hover {\n    filter: brightness(1);\n    color: white;\n}"),e.innerText=l.analyzeRating,e.href=function(e){const t=Array.from(document.querySelectorAll("script"));for(;t.length;){const e=t.pop();if(e?.src.includes("fetch-all")){const t=new URL(e.src),r=t.pathname;return t.origin+r.substring(0,r.lastIndexOf("/scripts"))}}return"https://dogeon188.github.io/chuni-tools/"}()+"/record-viewer/#best",e.target="recordViewer",c.getElementById("inner")?.insertAdjacentElement("beforebegin",e)}(),window.addEventListener("message",(function(e){switch(e.data.action){case"request":!function(e){const{payload:r,uuid:c}=e.data;console.log("%cReceived request for: %c"+r.target,"color: gray","color: white");const l=function(e,t){if(!e)throw new Error("Target window does not exist");return(r,n,o)=>{const a={action:r,payload:n};o&&(a.uuid=o),e.postMessage(a,t)}}(e.source,e.origin);let s;switch(r.target){case"bestRecord":console.log("%c    Target difficulty: %c"+r.data.difficulty,"color: gray","color: white"),s=async function(e=o.master){const r=new FormData;r.append("genre","99"),r.append("token",t("_t"));const a={[o.ultima]:"sendUltima",[o.master]:"sendMaster",[o.expert]:"sendExpert",[o.advanced]:"sendAdvanced",[o.basic]:"sendBasic"}[e],c=await i("/mobile/record/musicGenre/"+a,r);return Array.from(c.querySelectorAll(".box01.w420")[1].querySelectorAll("form")).map((t=>{const r=t.querySelector(".play_musicdata_icon"),o=t.querySelector(".text_b")?.innerHTML;return{title:t.querySelector(".music_title")?.innerHTML,score:o?n(o):-1,difficulty:e,clear:r?.querySelector('img[src*="alljustice"]')?"AJ":r?.querySelector('img[src*="fullcombo"]')?"FC":"",idx:t.querySelector('input[name="idx"]').value}})).filter((e=>e.title&&e.score))}(r.data.difficulty);break;case"playHistory":s=async function(){const e=await i("/mobile/record/playlog");return Array.from(e.querySelectorAll(".mt_10 .frame02.w400")).map((e=>{const t=e.querySelector(".play_musicdata_score_text")?.innerHTML,r=e.querySelector(".play_track_result img").src,a=/musiclevel_.*(?=\.png)/.exec(r)[0].slice(11),c=Array.from(e.querySelectorAll(".play_musicdata_icon"));return{title:e.querySelector(".play_musicdata_title").innerHTML,score:n(t),difficulty:"ultimate"==a?"ULT":"worldsend"==a?"WE":o[a],clear:c.some((e=>e.querySelector('img[src*="alljustice"]')))?"AJ":c.some((e=>e.querySelector('img[src*="fullcombo"]')))?"FC":"",timestamp:Date.parse(e.querySelector(".play_datalist_date").innerHTML)}}))}();break;case"recentRecord":s=async function(){const e=await i("/mobile/home/playerData/ratingDetailRecent");return Array.from(e.querySelectorAll("form")).map((e=>{const t=e.querySelector("input[name=diff]")?.value;return{title:e.querySelector(".music_title").innerHTML,score:n(e.querySelector(".text_b")?.innerHTML),difficulty:Object.values(o)[parseInt(t)],clear:""}}))}();break;case"playerStats":s=async function(){const e=await i("/mobile/home/playerData"),t=e.querySelector(".player_honor_short"),r=/honor_bg_.*(?=\.png)/.exec(t.style.backgroundImage),n=Array.from(e.querySelectorAll(".player_rating_num_block img")).map((e=>/rating_.*_comma.png/.test(e.src)?".":/rating_.*_[0-9]*(?=\.png)/.exec(e.src)[0].slice(-1))).join("");return{name:e.querySelector(".player_name_in").innerHTML,honor:{text:e.querySelector(".player_honor_text_view span").innerHTML,color:r?r[0].slice(9):"normal"},rating:n,ratingMax:e.querySelector(".player_rating_max").innerHTML,playCount:e.querySelector(".user_data_play_count .user_data_text").innerHTML,lastPlayed:Date.parse(e.querySelector(".player_lastplaydate_text").innerHTML)}}();break;case"songPlayCount":console.log("%c    Target song id: %c"+r.data.idx,"color: gray","color: white"),console.log("%c    Target difficulty: %c"+r.data.difficulty,"color: gray","color: white"),s=async function(e,r){const n=new FormData;n.append("idx",e),n.append("genre","99"),n.append("diff",a.indexOf(r).toString()),n.append("token",t("_t"));const c=(await i("/mobile/record/musicGenre/sendMusicDetail/",n)).querySelectorAll(`.music_box.bg_${Object.entries(o).find((e=>e[1]===r))[0]} .box14 > div`)[1].querySelector(".text_b")?.innerHTML.replace("times","");return parseInt(c)}(r.data.idx,r.data.difficulty)}l("ping",{target:r.target},c),s?.then((e=>{l("respond",{target:r.target,data:e},c)})).catch((e=>{console.error(e),l("respond",{target:r.target,error:e},c)}))}(e);break;case"saveConfig":const r=e.data.payload.data?.lang;r&&(function(e){localStorage.language=e}(r),console.log("%cChange language preferences to: %c"+r,"color: gray","color: white"))}}),!1)}catch(e){alert(l.needReload),console.log(e)}}(document)})();